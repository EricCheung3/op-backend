gitroot=~/openprice

# ========== Backend ==========

cd $gitroot/op-backend
mvn clean install -P prod -DskipTests


docker run --name op-mysql -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=openprice -e MYSQL_USER=openprice -e MYSQL_PASSWORD=openprice -v /groundtruth/mysql_data:/var/lib/mysql -d mysql:5.6

# Internal RESTful API Server, internal usage only
cd $gitroot/op-backend/server-internal-api
mvn docker:build
docker run --name op-server-internal-api -e ENV_NAME=openprice-prod -e SERVER_NAME=INTAPI -e SPRING_PROFILES_ACTIVE=sendgrid -e SENDGRID_USERNAME=groundtruthinc -e SENDGRID_PASSWORD=flrqth983PNRq -e LOGGING_FILE_FOLDER=/groundtruth/logs -v /groundtruth/logs:/groundtruth/logs -v /groundtruth/images:/groundtruth/images --link op-mysql:mysql -d opgt/op-server-internal-api

# Web RESTful API Server, for Web UI
cd $gitroot/op-backend/server-web-api
mvn docker:build
docker run --name op-server-web-api -e ENV_NAME=openprice-prod -e SERVER_NAME=WEBAPI -e SPRING_PROFILES_ACTIVE=sendgrid -e SENDGRID_USERNAME=groundtruthinc -e SENDGRID_PASSWORD=flrqth983PNRq -e LOGGING_FILE_FOLDER=/groundtruth/logs -v /groundtruth/logs:/groundtruth/logs -v /groundtruth/images:/groundtruth/images --link op-mysql:mysql --link op-server-internal-api:op-server-internal-api -d opgt/op-server-web-api

# ADMIN RESTful API Server, for Admin UI
cd $gitroot/op-backend/server-admin-api
mvn docker:build
docker run --name op-server-admin-api -e ENV_NAME=openprice-prod -e SERVER_NAME=ADMAPI -e SPRING_PROFILES_ACTIVE=sendgrid -e SENDGRID_USERNAME=groundtruthinc -e SENDGRID_PASSWORD=flrqth983PNRq -e LOGGING_FILE_FOLDER=/groundtruth/logs -v /groundtruth/logs:/groundtruth/logs -v /groundtruth/images:/groundtruth/images --link op-mysql:mysql --link op-server-internal-api:op-server-internal-api -d opgt/op-server-admin-api


# Web UI Server
cd $gitroot/op-web-ui
npm install
bower install
gulp build --env production

cd $gitroot/op-web-ui/docker
docker build -t opgt/op-server-web-ui .

docker run --name op-server-web-ui -d opgt/op-server-web-ui


# Admin UI Server
cd $gitroot/op-admin-ui
npm install
bower install
gulp build --env production

cd $gitroot/op-admin-ui/docker
docker build -t opgt/op-server-admin-ui .

docker run --name op-server-admin-ui -d opgt/op-server-admin-ui


# Proxy Server
docker run --name op-server-proxy -p 80:80 -v $gitroot/nginx/conf.d:/etc/nginx/conf.d --link op-server-web-ui:op-server-web-ui --link op-server-web-api:op-server-web-api --link op-server-admin-ui:op-server-admin-ui --link op-server-admin-api:op-server-admin-api -d nginx
